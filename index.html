<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Interval Camera (Snapshot Base + Overlays)</title>
  <style>
    body { margin:0; background:black; color:white; font-family:sans-serif; }
    #status { position:absolute; top:10px; left:10px; background:rgba(255,255,255,0.1); padding:6px; border-radius:6px; }
    #controls { position:absolute; bottom:20px; left:0; right:0; display:flex; flex-direction:column; align-items:center; gap:10px; }
    .row { display:flex; gap:20px; justify-content:center; }
    button { cursor:pointer; font-size:16px; }
    #baseBtn { width:80px; height:80px; border-radius:50%; background:white; border:2px solid black; }
    #startBtn { width:100px; height:100px; border-radius:50%; background:red; border:3px solid white; color:white; }
    select { font-size:14px; padding:4px; border-radius:6px; }
    #feedBox { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:80%; max-width:800px; aspect-ratio:4/3; border:2px solid white; background:black; }
    #video { display:none; }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="feedBox"></canvas>
  <canvas id="scratch" style="display:none;"></canvas>

  <div id="status">Loading…</div>
  <div id="controls">
    <div class="row">
      <button id="baseBtn">Base</button>
      <button id="startBtn" disabled>Start</button>
    </div>
    <div class="row">
      <label>Resolution: 
        <select id="resolution">
          <option value="640">640p</option>
          <option value="1280" selected>1280p</option>
          <option value="1920">1920p</option>
        </select>
      </label>
      <label>Interval: 
        <select id="interval">
          <option value="100">0.1s</option>
          <option value="200" selected>0.2s</option>
          <option value="500">0.5s</option>
          <option value="1000">1s</option>
        </select>
      </label>
    </div>
  </div>

  <script>
    const video = document.getElementById("video");
    const feedBox = document.getElementById("feedBox");
    const scratch = document.getElementById("scratch");
    const statusEl = document.getElementById("status");
    const baseBtn = document.getElementById("baseBtn");
    const startBtn = document.getElementById("startBtn");
    const resSel = document.getElementById("resolution");
    const intSel = document.getElementById("interval");

    let hasBase = false;

    // Use back camera when available
    navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
      .then(stream => {
        video.srcObject = stream;
        video.play();
        statusEl.textContent = "Camera ready — tap Base";
      })
      .catch(() => {
        statusEl.textContent = "Camera blocked — still usable";
      });

    function grabFrame() {
      if (!video.videoWidth) return null;
      scratch.width = video.videoWidth;
      scratch.height = video.videoHeight;
      const ctx = scratch.getContext("2d");
      ctx.drawImage(video, 0, 0);
      return scratch;
    }

    baseBtn.onclick = () => {
      const s = grabFrame();
      if (!s) return;
      const target = parseInt(resSel.value);
      const scale = target / Math.max(s.width, s.height);
      feedBox.width = Math.round(s.width * scale);
      feedBox.height = Math.round(s.height * scale);
      const ctx = feedBox.getContext("2d");
      ctx.globalAlpha = 1.0; // base solid
      ctx.drawImage(s, 0, 0, feedBox.width, feedBox.height);
      hasBase = true;
      baseBtn.disabled = true;
      startBtn.disabled = false;
      statusEl.textContent = "Base snapshot taken — press Start";
    };

    startBtn.onclick = () => {
      if (!hasBase) return;
      startBtn.disabled = true;
      const ctx = feedBox.getContext("2d");
      const interval = parseInt(intSel.value);
      setInterval(() => {
        const s = grabFrame();
        if (!s) return;
        ctx.globalAlpha = 0.75; // overlays semi-transparent
        ctx.drawImage(s, 0, 0, feedBox.width, feedBox.height);
      }, interval);
      statusEl.textContent = "Recording overlays…";
    };
  </script>
</body>
</html>
